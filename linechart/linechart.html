<script type="text/html" settings>
	<div class="padding">
        <div class="m" data-jc="dropdown" data-jc-path="id" data-jc-config="datasource:common.instances;empty:;if:n => n.component === 'dashboardanalytics';required:true">@(Flow instance)</div>
		<div data-jc="multioptions" data-jc-path="?">
			<script type="text/plain">
				option('background', 'Background Color', '#8CC152', 'Color');
				option('type', 'Type', 'days', ['hours', 'days', 'months', 'years']);
				option('high', 'High value', null, 'Number');
				option('low', 'Low value', null, 'Number');
				option('showArea', 'Show area', true);
				option('showPoint', 'Show point', true);
				option('showLine', 'Show line', true);
				option('smoothCurves', 'No smooth curves', true);
				option('XshowLabel', 'Axis X: Show Label', true);
				option('XshowGrid', 'Axis X: Show Grid', true);
				option('YshowLabel', 'Axis Y: Show Label', true);
				option('YshowGrid', 'Axis Y: Show Grid', false);
				option('onlyInteger', 'Whole numbers', true);
				option('dateFormat', 'Date format', 'dd.MM', ['HH:mm', 'dd', 'ddd', 'dd.MM', 'dd.MM.yyyy', 'MMMM', 'MM.yyyy']);
				option('formatter', 'Format', '{0}');
				option('decimals', 'Decimals', 1);
				option('reverse', 'Reverse', false);
			</script>
		</div>
	</div>
</script>

<style type="text/css">
	.dashboardlinechart .ct-label { font-size: 1rem; }
	.dashboardlinechart .ct-label.ct-horizontal.ct-end { transform: translate(-50%,0); display: block; text-align: center; }
	.dashboardlinechart .title { float: left; width: 100%; text-align: center; color: #fff; font-size: 1.5em; padding-top: 5px; margin-bottom: -10px; }
	.dashboardlinechart .chartwrapper { float: left; width: 100%; height: 100%; padding-bottom: 20px; }
	.dashboardlinechart .chart { width: 100%; height: 100%; }
</style>

<script type="text/html" body>
	<div style="height:100%">
		<div class="title"></div>
		<div class="chartwrapper">
			<div class="chart"></div>
		</div>
	</div>
</script>

<!-- DEMO DATA -->
<script type="text/json">
{ "id": "1491574013480", "hours": [ { "year": 2017, "month": 6, "day": 29, "hour": 0, "count": 60, "value": 26.5, "datecreated": "2017-07-06T06:03:15.362Z", "id": 2017062900 }, { "year": 2017, "month": 6, "day": 28, "hour": 0, "count": 144, "value": 35.9, "datecreated": "2017-06-28T22:00:51.492Z", "id": 2017062800 }, { "year": 2017, "month": 6, "day": 27, "hour": 0, "count": 144, "value": 35.6, "datecreated": "2017-06-27T22:00:48.824Z", "id": 2017062700 }, { "year": 2017, "month": 6, "day": 26, "hour": 0, "count": 136, "value": 29.7, "datecreated": "2017-06-26T22:00:13.651Z", "id": 2017062600 }, { "year": 2017, "month": 6, "day": 25, "hour": 0, "count": 132, "value": 34.9, "datecreated": "2017-06-25T22:00:56.310Z", "id": 2017062500 }, { "year": 2017, "month": 6, "day": 24, "hour": 0, "count": 135, "value": 33.2, "datecreated": "2017-06-24T22:00:14.975Z", "id": 2017062400 }, { "year": 2017, "month": 6, "day": 23, "hour": 0, "count": 144, "value": 27.3, "datecreated": "2017-06-23T22:00:36.155Z", "id": 2017062300 }, { "year": 2017, "month": 6, "day": 22, "hour": 0, "count": 144, "value": 35.1, "datecreated": "2017-06-22T22:00:33.585Z", "id": 2017062200 }, { "year": 2017, "month": 6, "day": 21, "hour": 0, "count": 144, "value": 34.4, "datecreated": "2017-06-21T22:00:30.990Z", "id": 2017062100 }, { "year": 2017, "month": 6, "day": 20, "hour": 0, "count": 143, "value": 35, "datecreated": "2017-06-20T22:00:28.383Z", "id": 2017062000 }, { "year": 2017, "month": 6, "day": 19, "hour": 0, "count": 144, "value": 33, "datecreated": "2017-06-19T22:00:25.771Z", "id": 2017061900 }, { "year": 2017, "month": 6, "day": 18, "hour": 0, "count": 144, "value": 25, "datecreated": "2017-06-18T22:00:23.132Z", "id": 2017061800 }, { "year": 2017, "month": 6, "day": 17, "hour": 0, "count": 138, "value": 21.2, "datecreated": "2017-06-17T22:00:20.489Z", "id": 2017061700 }, { "year": 2017, "month": 6, "day": 16, "hour": 0, "count": 144, "value": 24.1, "datecreated": "2017-06-16T22:00:17.844Z", "id": 2017061600 }, { "year": 2017, "month": 6, "day": 15, "hour": 0, "count": 143, "value": 30.3, "datecreated": "2017-06-15T22:00:15.227Z", "id": 2017061500 }, { "year": 2017, "month": 6, "day": 14, "hour": 0, "count": 144, "value": 28.8, "datecreated": "2017-06-14T22:00:54.924Z", "id": 2017061400 }, { "year": 2017, "month": 6, "day": 13, "hour": 0, "count": 144, "value": 29.9, "datecreated": "2017-06-13T22:00:52.373Z", "id": 2017061300 }, { "year": 2017, "month": 6, "day": 12, "hour": 0, "count": 144, "value": 30.3, "datecreated": "2017-06-12T22:00:49.763Z", "id": 2017061200 }, { "year": 2017, "month": 6, "day": 11, "hour": 0, "count": 144, "value": 31, "datecreated": "2017-06-11T22:00:47.124Z", "id": 2017061100 }, { "year": 2017, "month": 6, "day": 10, "hour": 0, "count": 144, "value": 30.9, "datecreated": "2017-06-10T22:00:44.522Z", "id": 2017061000 }, { "year": 2017, "month": 6, "day": 9, "hour": 0, "count": 144, "value": 30.3, "datecreated": "2017-06-09T22:00:41.923Z", "id": 2017060900 }, { "year": 2017, "month": 6, "day": 8, "hour": 0, "count": 143, "value": 30.2, "datecreated": "2017-06-08T22:00:39.383Z", "id": 2017060800 }, { "year": 2017, "month": 6, "day": 7, "hour": 0, "count": 143, "value": 24.3, "datecreated": "2017-06-07T22:00:23.718Z", "id": 2017060700 }, { "year": 2017, "month": 6, "day": 6, "hour": 0, "count": 144, "value": 29.5, "datecreated": "2017-06-06T22:00:21.050Z", "id": 2017060600 } ], "days": [ { "year": 2017, "month": 6, "day": 29, "hour": 0, "count": 60, "value": 26.5, "datecreated": "2017-07-06T06:03:15.362Z", "id": 20170629 }, { "year": 2017, "month": 6, "day": 28, "hour": 0, "count": 144, "value": 35.9, "datecreated": "2017-06-28T22:00:51.492Z", "id": 20170628 }, { "year": 2017, "month": 6, "day": 27, "hour": 0, "count": 144, "value": 35.6, "datecreated": "2017-06-27T22:00:48.824Z", "id": 20170627 }, { "year": 2017, "month": 6, "day": 26, "hour": 0, "count": 136, "value": 29.7, "datecreated": "2017-06-26T22:00:13.651Z", "id": 20170626 }, { "year": 2017, "month": 6, "day": 25, "hour": 0, "count": 132, "value": 34.9, "datecreated": "2017-06-25T22:00:56.310Z", "id": 20170625 }, { "year": 2017, "month": 6, "day": 24, "hour": 0, "count": 135, "value": 33.2, "datecreated": "2017-06-24T22:00:14.975Z", "id": 20170624 }, { "year": 2017, "month": 6, "day": 23, "hour": 0, "count": 144, "value": 27.3, "datecreated": "2017-06-23T22:00:36.155Z", "id": 20170623 }, { "year": 2017, "month": 6, "day": 22, "hour": 0, "count": 144, "value": 35.1, "datecreated": "2017-06-22T22:00:33.585Z", "id": 20170622 }, { "year": 2017, "month": 6, "day": 21, "hour": 0, "count": 144, "value": 34.4, "datecreated": "2017-06-21T22:00:30.990Z", "id": 20170621 }, { "year": 2017, "month": 6, "day": 20, "hour": 0, "count": 143, "value": 35, "datecreated": "2017-06-20T22:00:28.383Z", "id": 20170620 }, { "year": 2017, "month": 6, "day": 19, "hour": 0, "count": 144, "value": 33, "datecreated": "2017-06-19T22:00:25.771Z", "id": 20170619 }, { "year": 2017, "month": 6, "day": 18, "hour": 0, "count": 144, "value": 25, "datecreated": "2017-06-18T22:00:23.132Z", "id": 20170618 }, { "year": 2017, "month": 6, "day": 17, "hour": 0, "count": 138, "value": 21.2, "datecreated": "2017-06-17T22:00:20.489Z", "id": 20170617 }, { "year": 2017, "month": 6, "day": 16, "hour": 0, "count": 144, "value": 24.1, "datecreated": "2017-06-16T22:00:17.844Z", "id": 20170616 } ], "months": [ { "year": 2017, "month": 6, "day": 1, "hour": 0, "count": 144, "value": 35.9, "datecreated": "2017-06-01T22:00:16.990Z", "id": 201706 }, { "year": 2017, "month": 5, "day": 1, "hour": 0, "count": 144, "value": 33.4, "datecreated": "2017-05-01T22:00:52.978Z", "id": 201705 }, { "year": 2017, "month": 4, "day": 7, "hour": 16, "count": 51, "value": 22.2, "datecreated": "2017-04-07T22:00:11.310Z", "id": 201704 } ], "years": [ { "year": 2017, "month": 4, "day": 7, "hour": 16, "count": 51, "value": 35.9, "datecreated": "2017-04-07T22:00:11.310Z", "id": 2017 } ], "period": "hourly", "type": "max", "format": "{0} °C", "decimals": 0, "hourslength": 24, "dayslength": 14, "monthslength": 12, "yearslength": 5 }
</script>

<script>
exports.name = 'linechart';
exports.title = 'Line chart';
exports.icon = 'fa-line-chart';
exports.author = 'Peter Širka';
exports.group = 'Analytics';
exports.options = { id: null, background: '#434A54', type: 'days', high: null, low: null, showArea: true, showPoint: true, showLine: true, smoothCurves: true, XshowLabel: true, XshowGrid: true, YshowLabel: true, YshowGrid: false, onlyInteger: true, dateFormat: 'dd.MM', formatter: '{0}', decimals: 1 };
exports.version = '1.1.0';

exports.install = function(instance) {

	var chart, backup;

	instance.shade = function(color, percent) {
		var R = parseInt(color.substring(1,3),16);
		var G = parseInt(color.substring(3,5),16);
		var B = parseInt(color.substring(5,7),16);

		R = parseInt(R * (100 + percent) / 100);
		G = parseInt(G * (100 + percent) / 100);
		B = parseInt(B * (100 + percent) / 100);

		R = (R<255)?R:255;
		G = (G<255)?G:255;
		B = (B<255)?B:255;

		var RR = ((R.toString(16).length==1)?'0'+R.toString(16):R.toString(16));
		var GG = ((G.toString(16).length==1)?'0'+G.toString(16):G.toString(16));
		var BB = ((B.toString(16).length==1)?'0'+B.toString(16):B.toString(16));

		return '#' + RR + GG + BB;
	};

	instance.on('data', function(response, fromresize) {

		if (RELEASE && (!instance.options.id || response.id !== instance.options.id || response.type !== 'stats'))
			return;

		backup = response;

		var size = instance.size;
		var data = {};
		var value = response.body;

		!fromresize && instance.options.reverse && value[instance.options.type].reverse();

		data.labels = [];
		data.series = [[]];

		var c = (size.width / 40) >> 0;
		var l = value[instance.options.type].length;
		if (c < l)
			value[instance.options.type] = value[instance.options.type].ticks(c);

		value[instance.options.type].forEach(function(item) {
			data.labels.push(item.datecreated.format(instance.options.dateFormat));
			data.series[0].push(item.value);
		});

		if (chart) {
			chart.update(data);
			return;
		}

		setTimeout2('redraw' + instance.id, function() {

			var options = {};
			var opt = instance.options;

			options.fullWidth = true;
			options.chartPadding = { left: 0, right: 20, bottom: 0, top: 20 };
			options.showArea = opt.showArea;
			options.showLine = opt.showLine;
			options.showPoint = opt.showPoint;

			if (opt.smoothCurves)
				options.lineSmooth = Chartist.Interpolation.step();

			opt.low && (options.low = opt.low);
			opt.high && (options.high = opt.high);
			options.axisY = {};
			options.axisY.labelInterpolationFnc = function(v) {
				return opt.formatter.format(v.format(opt.decimals));
			};
			options.axisY.onlyInteger = opt.onlyInteger;
			options.axisY.showGrid = opt.YshowGrid;
			options.axisY.showLabel = opt.YshowLabel;
			options.axisX = {};
			options.axisX.showGrid = opt.XshowGrid;
			options.axisX.showLabel = opt.XshowLabel;
			options.axisX.position = 'middle';
			options.width = size.width - 16;
			options.height = size.height - 40;
			chart = new Chartist.Line(instance.element.find('.chart').get(0), data, options);
			instance.find('.title').html(value.name || 'Chart title');
		}, 500);
	});

	instance.on('destroy', function() {
		$('#style' + instance.id).remove();
	});

	instance.reconfigure = function() {
		var options = instance.options;
		var color = options.background;
		var area = instance.shade(color, 20);
		var line = instance.shade(color, 20);
		var point = instance.shade(color, -20);
		$('#style' + instance.id).remove();
		$('<style type="text/css" id="style{0}">{1}</style>'.format(instance.id, '.style{3} .ct-series-a .ct-area{fill:#FFFFFF}\n.style{3} .ct-series-a .ct-line{stroke:{1};}\n.style{3} .ct-series-a .ct-point{stroke:#FFFFFF;}.ct-label{color:#FFFFFF;}.style{3} .ct-grid{stroke:#FFFFFF;stroke-opacity:.2}'.format(area, line, point, instance.id))).appendTo('head');
		instance.css('background-color', color);
		chart && chart.detach();
		chart = null;

		// Refresh data
		options.id && instance.send(options.id, 'stats');
	};

	instance.on('resize', function() {
		chart && chart.detach();
		chart = null;
		backup && instance.emit('data', backup, true);
	});

	instance.make = function() {
		instance.element.aclass('dashboardlinechart style' + instance.id);
		instance.reconfigure();
	};

	instance.on('options', instance.reconfigure);
};

// Dependencies
IMPORT('ONCE https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.0/chartist.min.js');
IMPORT('ONCE https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.0/chartist.min.css');
</script>
